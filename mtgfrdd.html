<html>
<head>
    <meta charset="utf-8" />
    <title>AngularJS Plunker</title>
    <script>document.write('<base href="' + document.location + '" />');</script>
    <script data-require="angular.js@1.4.x" src="https://code.angularjs.org/1.4.8/angular.js" data-semver="1.4.8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.15/angular-ui-router.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-animate.min.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>

    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.1.1/bootstrap.min.css">

    <script data-require="jquery" data-semver="2.1.4" src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script data-require="bootstrap" data-semver="3.3.6" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <script>
        var Colon = function(nom, dateNaissance, sante, santeMax, str, int, cour, soc, agi) {
            this.nom = nom;
            this.dateNaissance = dateNaissance;
            this.str = str;
            this.int = int;
            this.cour = cour;
            this.soc = soc;
            this.agi = agi;
            this.sante = sante;
            this.santeMax = santeMax;
        };

        var PBatiment = function(nom, desc, longevite, cout) {
            this.nom = nom;
            this.desc = desc;
            this.cout = cout;
            this.longevite = longevite;
        };


        var PMission = function(nom, desc, code) {
            this.nom = nom;
            this.desc = desc;
            this.code = code;
        };


        var Cout = function(valeur) {
            this.valeurs = _.countBy(valeur.split(""));
        };
        Cout.prototype.soustraction = function(cout) {
        };
        Cout.prototype.ajout = function(valeur) {
            var self = this;
            _.each(valeur.split(""), function(v) {
                if (self.valeurs[v]) {
                    self.valeurs[v]++;
                } else {
                    self.valeurs[v] = 1;
                }
            });
        };

        Cout.prototype.affichage = function() {
            return _.map(this.valeurs, function(val, key) {
                switch(key) {
                    case "B" : return "Bois " + val;
                    case "P" : return "Pierre " + val;
                    case "A" : return "Argile " + val;
                    case "b" : return "Brique " + val;
                    case "O" : return "Or " + val;
                    case "F" : return "Fer " + val;
                    case "f" : return "Fruits " + val;
                    case "c" : return "Bois " + val;
                    case "t" : return "Tissu " + val;

                }
            });
        };

        var Partie = function() {
            this.protoMissions = [
                new PMission("rien glander", "ou aller sur internet", "RG"),
                new PMission("ramasser du bois", "Récupère du bois", "RB"),
                new PMission("couper du bois", "Récupère du bois", "CB"),
                new PMission("ramasser de l'argile", "Ramasse de l'argile", "RA"),
                new PMission("ramasser des cailloux", "", "RC"),
                new PMission("creuser une mine", "Creuse une mine", "CM"),
                new PMission("travailler dans la mine", "extraire des minéraux", "TM"),
                new PMission("construire un bâtiment", "Contruire un des bâtiments", "CBat"),
                new PMission("chasser", "miam", "CH"),
                new PMission("cueillette", "miam", "CU"),
                new PMission("explorer", "miam", "EX")
            ];
            this.protoBatiments = [
                new PBatiment("scierie en bois", "Cree du bois", 10, "BBBBB"),
                new PBatiment("scierie en pierre", "Cree du bois", 20, "PPP"),
                new PBatiment("carrière", "Cree du bois", 20, "PPP"),
                new PBatiment("taille de pierre", "Cree du bois", 20, "BBBFFF"),
                new PBatiment("mine", "Extrait des mineraux", 20, "BBB"),
                new PBatiment("cabane", "Pour dormir", 10, "BBB"),
                new PBatiment("maison", "Pour dormir", 20, "BBBBBPPPP")
            ];
            this.colonsStock = [
                new Colon("Ranche", 1370, 20, 20, 1, 1, 1, 1),
                new Colon("Xuelynom", 1370, 20, 20, 1, 1, 1, 1),
                new Colon("Kobold", 1370, 20, 20, 2, 1, 1, 1),
                new Colon("Imagination", 1370, 20, 20, 1, 1, 1, 1),
                new Colon("Mattevski", 1370, 20, 20, 1, 1, 1, 1),
                new Colon("Smc", 1370, 20, 20, 1, 1, 1, 1),
                new Colon("Snoxx", 1370, 20, 20, 1, 1, 1, 1),
                new Colon("Pamy", 1370, 20, 20, 1, 1, 1, 1)
            ];
        };
        Partie.prototype.demarre = function() {
            var self = this;
            this.reserve = new Cout("BB");
            this.annee = 1400;
            this.colons = _.shuffle(this.colonsStock).slice(0, 5);
            _.each(this.colons, function(colon) {
                colon.mission = self.protoMissions[0];
            });
            this.batiments = [];
            this.jour = 1;
        };

        Partie.prototype.finitTour = function() {
            var self = this;

        };

        var c = new Cout("BBDDD");
        c.ajout("DDE");
        console.log(c);

        angular.module('Mtgfrdd', []).controller('MtgfrddCtrl', function($scope, $interval){
            //$interval(update, 1000);

            var partie = new Partie();
            partie.demarre();

            $scope.partie = partie;

            $scope.valider = function() {
                var resultat = ["Fin du jour " + partie.jour + " de l'année " + partie.annee];
                _.each(partie.colons, function(colon) {
                    if (colon.mort) {
                        return;
                    }
                    colon.sante -= 3;
                    switch(colon.mission.code) {
                        case "RB" : resultat.push(colon.nom + " recolte 1 bois;"); partie.reserve.ajout("B"); break;
                        case "RP" : resultat.push(colon.nom + " recolte 1 pierre;"); partie.reserve.ajout("P"); break;
                        case "CH" : resultat.push(colon.nom + " recolte 1 pierre;"); partie.reserve.ajout("ffff"); break;
                        case "RG" : resultat.push(colon.nom + " se repose. +1 Santé"); colon.sante ++; break;
                    }

                    if (colon.maison) {
                        resultat.push(colon.nom + " dort dans son lit; +1 Santé");
                        colon.sante ++;
                    } else {
                        resultat.push(colon.nom + " dort à la belle étoile et est fatigué;");
                    }
                    if (colon.sante <= 0) {
                        resultat.push(colon.nom + " meurt;");
                        colon.mort = true;
                    }
                });
                _.each(self.batiments, function(batiment) {
                    if (!batiment.ruines) {
                        batiment.durabilite--;
                        if (batiment.durabilite === 0) {
                            batiment.ruines = true;
                        }
                    }
                });
                partie.jour++;
                if (partie.jour === 30) {
                    partie.jour = 1;
                    partie.annee++;
                }
                resultat.push("Nouveau jour : jour " + partie.jour + " de l'année " + partie.annee);
                $scope.resultat = resultat;
            }
        });
    </script>
</head>

<body>
<div ng-app="Mtgfrdd">
    <div  ng-controller="MtgfrddCtrl">
        <h1>MtgFrDankDungeon 1.1</h1>

        <h3>Règles</h3>
        Les bâtiments se dégradent : 1/2 chances de perdre 1 pt de durabilité.
        <BR/>
        <h3>{{partie.jour}} de l'année {{partie.annee}}</h3>

        <table>
            <tr>
                <td>Reserve</td>
                <td>Colons</td>
                <td>Batiments</td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td><span>{{partie.reserve.affichage()}}</span></td>
                <td>
                    <div ng-repeat="colon in partie.colons">
                        <button  ng-click="partie.selectedColon = colon; partie.selectedBatiment = null;">{{colon.nom}}</button>
                        <BR/>
                        {{colon.mission.nom}}
                        <BR/>
                        Santé : {{colon.sante}}
                    </div>
                </td>
                <td>
                    <div ng-repeat="batiment in partie.batiments" ng-click="partie.selectedBatiment = batiment; partie.selectedColon = null;">
                        {{batiment.nom}}
                    </div>
                </td>
                <td>
                    <div style="width : 50%" ng-show="partie.selectedColon">
                        <h4>Colon {{partie.selectedColon.nom}}</h4>
                        Age : {{partie.annee - partie.selectedColon.dateNaissance}} ans | Santé : {{partie.selectedColon.sante}}
                        <BR/>
                        Mission : <select class="form-control" ng-model="partie.selectedColon.mission" ng-options="mission as mission.nom for mission in partie.protoMissions"></select>
                        <BR/>
                        <select ng-show="partie.selectedColon.mission.code === 'CBat'" class="form-control" ng-model="partie.selectedColon.missionBatiment" ng-options="protoBatiment as protoBatiment.nom for protoBatiment in partie.protoBatiments"></select>
                    </div>
                </td>
            </tr>
        </table>

        <button class="btn btn-primary" ng-click="valider()" >Valider</button>
        <BR/>
        <h4>Journée précédente</h4>
        <span ng-repeat="ligne in resultat">
            {{ligne}}
            <BR/>
        </span>
    </div>
</div>

</body>

</html>
