function HTMLActuator() {
	this.tileContainer = document.querySelector(".tile-container");
	this.scoreContainer = document.querySelector(".score-container");
	this.bestContainer = document.querySelector(".best-container");
	this.messageContainer = document.querySelector(".game-message");
	this.verticalMan = document.querySelector(".verticalMan");
	this.horizontalMan = document.querySelector(".horizontalMan");

	this.score = 0;
	this.sizeTile = 80;
	this.marginTile = 0;
	this.keylock = 0;
}

HTMLActuator.prototype.actuate = function(grid, metadata) {
	var self = this;
	window.requestAnimationFrame(function() {
		self.clearContainer(self.tileContainer);

		grid.cells.forEach(function(column) {
			column.forEach(function(tonneau) {
				if (tonneau) {
					// alert("tonneau" + cell.x + " " + cell.y);
					self.addTonneau(tonneau);
				}
			});
		});
		grid.oldTiles.forEach(function(tonneau) {
			self.addTonneau(tonneau);
		});

		self.updateScore(metadata.score);
		self.updateBestScore(metadata.bestScore);

		if (metadata.terminated) {
			if (metadata.over) {
				self.message(false); // You lose
			} else if (metadata.won) {
				self.message(true); // You win!
			}
		}

	});
};

HTMLActuator.prototype.actuateMan = function(direction) {
	var self = this;

	window.requestAnimationFrame(function() {
		var left = 0;
		var top = 0;
		var taille = self.sizeTile;
		if (direction == 0) {
			$('.horizontal-man').animate({
				"left" : "+=" + 0 + "px",
				"top" : "-=" + self.sizeTile + "px"
			}, 200, 'linear');
		}
		if (direction == 2) {
			$('.horizontal-man').animate({
				"left" : "+=" + 0 + "px",
				"top" : "+=" + self.sizeTile + "px"
			}, 200, 'linear');
		}
		if (direction == 1) {
			$('.vertical-man').animate({
				"left" : "+=" + self.sizeTile + "px",
				"top" : "+=" + "0" + "px"
			}, 200, 'linear');
		}
		if (direction == 3) {
			$('.vertical-man').animate({
				"left" : "-=" + self.sizeTile + "px",
				"top" : "+=" + "0" + "px"
			}, 200, 'linear');
		}
	});
};

// Continues the game (both restart and keep playing)
HTMLActuator.prototype.continueGame = function() {
	this.clearMessage();
};

HTMLActuator.prototype.clearContainer = function(container) {
	while (container.firstChild) {
		container.removeChild(container.firstChild);
	}
};

HTMLActuator.prototype.addTonneau = function(tonneau) {
	var self = this;

	var wrapper = document.createElement("div");
	var inner = document.createElement("div");
	var position = tonneau.previousPosition || {
		x : tonneau.x,
		y : tonneau.y
	};

	wrapper.setAttribute("class", "tile tile-" + tonneau.value);
	var posDepartLeft = tonneau.x * this.sizeTile;
	var posDepartTop = tonneau.y * this.sizeTile;
	if (tonneau.previousPosition) {
		posDepartLeft = this.marginTile + (tonneau.previousPosition.x * this.sizeTile);
		posDepartTop = this.marginTile + (tonneau.previousPosition.y * this.sizeTile);
	}

	wrapper.setAttribute("style", "left:" + posDepartLeft + "px;top:" + posDepartTop + "px;");

	inner.classList.add("tile-inner");
	inner.textContent = tonneau.value;
	
	if (tonneau.previousPosition) {
		var diffx = (tonneau.x - tonneau.previousPosition.x) * self.sizeTile;
		var diffy = (tonneau.y - tonneau.previousPosition.y) * self.sizeTile;
		var nbCases = Math.abs((tonneau.x - tonneau.previousPosition.x) + (tonneau.y - tonneau.previousPosition.y));
		// console.log(nbCases);
		self.keylock++;
		// vidage vers le bas
		if (tonneau.vidage == 'y') {
			console.log("vidate y");
			$(wrapper).animate({
				"left" : "+=" + diffx + "px",
				"top" : "+=" + diffy + "px"
			}, nbCases * 400, 'linear')
			.animate({
				"left" : "+=" + tonneau.x * self.sizeTile + "px"
			}, (6 - tonneau.x) * 400, 'linear', function() {
				self.keylock--;
			});

			/*$(wrapper).animate({
				"left" : "+=" + tonneau.x * self.sizeTile + "px"
			}, tonneau.x * 400, 'linear', function() {
				self.keylock--;
			});*/
		} else if (tonneau.vidage == 'x') {
			/*console.log("vidate x");
			$(wrapper).animate({
				"left" : "+=" + diffx + "px",
				"top" : "+=" + diffy + "px"
			}, nbCases * 400, 'linear')
			.animate({
				"left" : "+=" + (6 - tonneau.x) + "px"
			}, (6 - tonneau.y) * 400, 'linear', function() {
				self.keylock--;
			});

			$(wrapper).animate({
				"top" : "+=" + tonneau.y * self.sizeTile + "px"
			}, tonneau.y * 400, 'linear', function() {
				self.keylock--;
			});*/
		} else {
			$(wrapper).animate({
				"left" : "+=" + diffx + "px",
				"top" : "+=" + diffy + "px"
			}, nbCases * 400, 'linear', function() {
				self.keylock--;
			});
		}
	}

	wrapper.appendChild(inner);
	this.tileContainer.appendChild(wrapper);
};

HTMLActuator.prototype.updateScore = function(score) {
	this.clearContainer(this.scoreContainer);

	var difference = score - this.score;
	this.score = score;

	this.scoreContainer.textContent = this.score;

	if (difference > 0) {
		var addition = document.createElement("div");
		addition.classList.add("score-addition");
		addition.textContent = "+" + difference;

		this.scoreContainer.appendChild(addition);
	}
};

HTMLActuator.prototype.updateBestScore = function(bestScore) {
	this.bestContainer.textContent = bestScore;
};

HTMLActuator.prototype.message = function(won) {
	var type = won ? "game-won" : "game-over";
	var message = won ? "You win!" : "Game over!";

	this.messageContainer.classList.add(type);
	this.messageContainer.getElementsByTagName("p")[0].textContent = message;
};

HTMLActuator.prototype.clearMessage = function() {
	// IE only takes one value to remove at a time.
	this.messageContainer.classList.remove("game-won");
	this.messageContainer.classList.remove("game-over");
};
